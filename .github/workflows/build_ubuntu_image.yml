name: Release Ubuntu Images
on:
  push:
    branches:
      - master
  workflow_dispatch:


env:
  18.04_t: '18_04'
  20.04_t: '20_04'

jobs:
  default:
    strategy:
      matrix:
        distrib: ['18.04', '20.04']

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}REKT" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build default image
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:default 

          docker build $GITHUB_WORKSPACE/images/ubuntu \
          --tag $IMAGE_NAME \
          --label "runnumber=${GITHUB_RUN_ID}" \
          --build-arg version=${{ matrix.distrib }}

      - name: Push default image
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:default 

          IMAGE_ID=$(echo ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME | tr '[A-Z]' '[a-z]')
          docker tag $IMAGE_NAME $IMAGE_ID
          docker push $IMAGE_ID


      - name: Get tags
        if: always()
        uses: actions/checkout@v2
        with:
          ref: 'tags'
          path: 'generated_tags'

      - name: Generate badge
        env:
          TAG_COLOR: brightgreen
          MSG: passing
        if: always()
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:default

          wget -O generated_tags/$IMAGE_NAME.svg https://img.shields.io/badge/$IMAGE_NAME-$MSG-$TAG_COLOR?style=plastic&logo=docker
          cd generated_tags
          git config --global user.name ${{ github.actor }}
          git config --global user.email '${{ github.actor }}@users.noreply.github.com'
          git add $IMAGE_NAME.svg
          git commit -m "Update badges"
          git push -f


  clang:
    needs: default
    strategy:
      matrix:
        distrib: ['18.04', '20.04']
        compiler: ['clang-12', 'clang-13', 'clang-14']
        exclude:
          - distrib: '18.04'
            compiler: 'clang-14'
            
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}REKT" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build ${{ matrix.compiler }} image
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:${{ matrix.compiler }}

          docker build $GITHUB_WORKSPACE/images/ubuntu/${{ matrix.compiler }} \
          --tag $IMAGE_NAME \
          --label "runnumber=${GITHUB_RUN_ID}" \
          --build-arg base_tag=$IMAGE_TAG

      - name: Push default image
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:${{ matrix.compiler }}
          IMAGE_ID=$(echo ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME | tr '[A-Z]' '[a-z]')

          docker tag $IMAGE_NAME $IMAGE_ID
          docker push $IMAGE_ID
      - name: Generate badge
        env:
          TAG_COLOR: brightgreen
          MSG: passing
        if: always()
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:${{ matrix.compiler }}

          git clone -b tags git@github.com:Yuki-cpp/yuki_docker.git generated_tags
          wget -O generated_tags/$IMAGE_NAME.svg https://img.shields.io/badge/$IMAGE_NAME-$MSG-$TAG_COLOR?style=plastic&logo=docker
          git commit -am "Update badges"
          git push -f
      - name: Push badge
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: tags
          FOLDER: generated_tags
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  gcc:
    needs: clang
    strategy:
      matrix:
        distrib: ['18.04', '20.04']
        compiler: ['gcc-10', 'gcc-11']
            
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build ${{ matrix.compiler }} image
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:${{ matrix.compiler }} 

          docker build $GITHUB_WORKSPACE/images/ubuntu/${{ matrix.compiler }} \
          --tag $IMAGE_NAME \
          --label "runnumber=${GITHUB_RUN_ID}" \
          --build-arg base_tag=$IMAGE_TAG

      - name: Push default image
        run: |
          IMAGE_TAG=$(echo ${{ matrix.distrib }} | tr '.' '_')
          IMAGE_NAME=ubuntu_$IMAGE_TAG:${{ matrix.compiler }} 
          IMAGE_ID=$(echo ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME | tr '[A-Z]' '[a-z]')

          docker tag $IMAGE_NAME $IMAGE_ID
          docker push $IMAGE_ID
